# 業務ルール定義

## 本ドキュメントの目的

本ドキュメントは、本システムにおける
**業務上の制約・前提・例外・権限ルール**を定義する。

ユースケース定義（`01_usecases.md`）で定義された
「何ができるか」に対し、
本ドキュメントでは「**どのような条件・制約のもとで行われるか**」を明確にする。

## 前提

- 本システムは登録済みユーザーのみが利用できる
- アクセス制御・権限の詳細は `04_access_policy.md` に従う

## 研究会に関する業務ルール

- 研究会は、継続的に開催される将棋の集まりを表す
- 研究会には複数の開催回が属する
- 研究会には 1 人以上の参加者が存在する

### 研究会削除

- 研究会を削除した場合、研究会配下のデータは削除される
- 削除対象には以下を含む
  - 開催回
  - 対局結果
  - 対局結果の編集履歴

## ロールに関する業務ルール

### ロールの体系

- 研究会には研究会ロールが存在する
  - CircleOwner / CircleManager / CircleMember
- 開催回には開催回ロールが存在する
  - CircleSessionOwner / CircleSessionManager / CircleSessionMember
- ロールは階層構造を持つ
  - Owner > Manager > Member

### ロールの排他性

- 研究会参加者は、研究会ごとに **必ず 1 つの研究会ロール**を持つ（複数同時保持は不可）
- 開催回参加者は、開催回ごとに **必ず 1 つの開催回ロール**を持つ（複数同時保持は不可）

### Owner に関する不変条件

- 研究会の CircleOwner は **必ず 1 人**である（0 人・2 人以上は禁止）
- 開催回の CircleSessionOwner は **必ず 1 人**である（0 人・2 人以上は禁止）

### Owner 移譲時のロール遷移

- 研究会オーナーを移譲した場合、移譲元オーナーは **CircleManager** になる
- 開催回オーナーを移譲した場合、移譲元オーナーは **CircleSessionManager** になる

### ロール変更に関する制約

- ロール変更操作では、**自分より上位のロールを持つ参加者のロールを変更できない**
  - 例: CircleManager は CircleOwner のロールを変更できない
  - 例: CircleSessionManager は CircleSessionOwner のロールを変更できない

## 開催回に関する業務ルール

- 開催回は必ず 1 つの研究会に属する
- 開催回は、研究会における 1 回分の開催を表す
- 開催回のタイトルは最大 100 文字とする
- 開催回には開始日時・終了日時が存在する
  - 通常は同日中に終了する
  - 例外として、複数日にわたる開催も許容する
- 開催回には必ず 1 人以上の参加者が存在する
- 開催回に参加できるのは登録済みユーザーのみである
- 研究会の参加者でないユーザーも、開催回に参加できる

### 開催回参加者の参加取消（除外）

- 開催回参加者の参加取消（除外）は許容する
- ただし、以下の場合は参加取消できない
  - 当該ユーザーが、当該開催回に属する対局結果の対局者として 1 件以上記録されている場合（論理削除を含む）
- 参加取消の結果として、開催回参加者が 0 人になることは許容しない

## 対局結果に関する業務ルール

- 対局結果は開催回に属する
- 対局は、開催回の参加者同士で行われる
- 対局者は開催回参加者である必要がある（開催回参加者 ⊇ 対局者）

### 対局結果の順序

- 対局結果には、開催回内の順序が存在する
- 順序は開催回ごとに一意であり、同一開催回内で重複してはならない

### 対局結果の削除

- 対局結果の削除は論理削除として扱い、編集履歴を含む記録は残る
- 対局結果を論理削除しても、開催回内の順序は再利用しないため欠番が発生し得る

## 対局結果の編集履歴

- 対局結果の作成・修正・削除時には、編集履歴を自動的に保存する
- 編集履歴はシステムが自動的に記録するものであり、ユーザーが直接操作することはできない
- ユーザーは編集履歴を閲覧することのみができる
- 編集履歴には以下の情報を含める
  - 編集者
  - 編集日時
  - 編集時点の対局結果内容

## スコープ外・前提事項

以下の事項は、本システムのスコープ外とする。

- 棋譜の保存
- 手合割・持ち時間の管理
- レーティング計算
- 勝敗集計のリアルタイム更新
- 研究会の検索
- 招待の承認フロー
