# 業務ルール定義

## 本ドキュメントの目的

本ドキュメントは、本システムにおける
**業務上の制約・前提・例外・権限ルール**を定義する。

ユースケース定義（`01_usecases.md`）で定義された
「何ができるか」に対し、
本ドキュメントでは「**どのような条件・制約のもとで行われるか**」を明確にする。

## 前提

- 本システムは登録済みユーザーのみが利用できる
- アクセス制御・権限の詳細は `04_access_policy.md` に従う

## 研究会に関する業務ルール

- 研究会は、継続的に開催される将棋の集まりを表す
- 研究会には複数のセッションが属する
- 研究会には 1 人以上の参加者が存在する

### 研究会削除

- 研究会を削除した場合、研究会配下のデータは**すべて削除**される
- 削除対象には以下を含む
  - セッション
  - 対局結果
  - 対局結果の編集履歴
  - メンバーシップ（過去に脱退・除名されたメンバーの記録を含む）

## ロールに関する業務ルール

### ロールの体系

- 研究会には研究会ロールが存在する
  - CircleOwner / CircleManager / CircleMember
- セッションにはセッションロールが存在する
  - CircleSessionOwner / CircleSessionManager / CircleSessionMember
- ロールは階層構造を持つ
  - Owner > Manager > Member

### ロールの排他性

- 研究会参加者は、研究会ごとに **必ず 1 つの研究会ロール**を持つ（複数同時保持は不可）
- セッション参加者は、セッションごとに **必ず 1 つのセッションロール**を持つ（複数同時保持は不可）

### Owner に関する不変条件

- 研究会の CircleOwner は **必ず 1 人**である（0 人・2 人以上は禁止）
- セッションの CircleSessionOwner は **必ず 1 人**である（0 人・2 人以上は禁止）

### Owner 移譲時のロール遷移

- 研究会オーナーを移譲した場合、移譲元オーナーは **CircleManager** になる
- セッションオーナーを移譲した場合、移譲元オーナーは **CircleSessionManager** になる

### ロール変更に関する制約

- ロール変更操作では、**自分より上位のロールを持つ参加者のロールを変更できない**
  - 例: CircleManager は CircleOwner のロールを変更できない
  - 例: CircleSessionManager は CircleSessionOwner のロールを変更できない

## 招待リンクに関する業務ルール

- 研究会のメンバーは招待リンクを生成できる
- 招待リンクには有効期限がある（デフォルト7日間）
- 招待リンクは複数回使用可能（1リンクで複数人が参加できる）
- 招待リンクを使用して参加した場合、ロールは CircleMember になる
- 有効期限が切れた招待リンクは使用できない
- 既に研究会に参加しているユーザーが招待リンクを使用した場合、エラーにはせず研究会ページに遷移する
- 未登録ユーザーが招待リンクを開いた場合、ログインまたはアカウント作成を促す

## 研究会メンバーの脱退・除名

- 研究会メンバーの脱退・除名後も、そのメンバーの記録は保持される
- 研究会を脱退・除名されても、セッションの参加状態や権限には影響しない
- 脱退・除名後の再加入は可能である
- CircleOwner は脱退・除名できない（先にオーナー移譲が必要）
- メンバー数のカウントはアクティブなメンバーのみを対象とする

## セッションに関する業務ルール

- セッションは必ず 1 つの研究会に属する
- セッションは、研究会における 1 回分の開催を表す
- セッションのタイトルは最大 100 文字とする
- セッションには開始日時・終了日時が存在する
  - 通常は同日中に終了する
  - 例外として、複数日にわたる開催も許容する
- セッションには必ず 1 人以上の参加者が存在する
- セッションに参加できるのは登録済みユーザーのみである
- 研究会の参加者でないユーザーも、セッションに参加できる

### セッション参加者の参加取消（除外）

- セッション参加者の参加取消（除外）は許容する
- 参加取消後も、その参加者の記録は保持される
- 対局記録がある参加者も参加取消が可能
- 参加者数のカウントはアクティブな参加者のみを対象とする
- 参加取消の結果として、アクティブなセッション参加者が 0 人になることは許容しない

## 対局結果に関する業務ルール

- 対局結果はセッションに属する
- 対局は、セッションの参加者同士で行われる
- 対局者はセッション参加者である必要がある（セッション参加者 ⊇ 対局者）

### 対局結果の順序

- 対局結果には、セッション内の順序が存在する
- 順序はセッションごとに一意であり、同一セッション内で重複してはならない

### 対局結果の削除

- 対局結果を削除しても、編集履歴を含む記録は保持される
- 対局結果を削除しても、セッション内の順序は再利用しないため欠番が発生し得る

## 対局結果の編集履歴

- 対局結果の作成・修正・削除時には、編集履歴を自動的に保存する
- 編集履歴はシステムが自動的に記録するものであり、ユーザーが直接操作することはできない
- ユーザーは編集履歴を閲覧することのみができる
- 編集履歴には以下の情報を含める
  - 編集者
  - 編集日時
  - 編集時点の対局結果内容

## スコープ外・前提事項

以下の事項は、本システムのスコープ外とする。

- 棋譜の保存
- 手合割・持ち時間の管理
- レーティング計算
- 勝敗集計のリアルタイム更新
- 研究会の検索
- 招待の承認フロー（招待リンクは即参加、承認は不要）
