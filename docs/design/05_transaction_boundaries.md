# トランザクション境界

## 目的

本ドキュメントは、ユースケース実行時のトランザクション境界を定義する。
データ整合性の担保はアプリケーションサービス（ユースケース）で行い、
リポジトリはデータ取得/永続化のみを担う。

## 前提

- db:push 運用のため、DB 制約は最小限に留める
- 複数更新が必要なユースケースはアプリケーション層でトランザクションを張る
- Prisma のトランザクション機構を利用する

## 原則

- 1 ユースケース = 1 トランザクション
- 事前条件の検証と更新は同一トランザクション内で行う
- 例外発生時は全てロールバックする

## 対象ユースケース（トランザクションが必須）

- 研究会オーナー移譲
  - 旧 Owner を Manager に変更
  - 新 Owner を Owner に変更
- セッションオーナー移譲
  - 旧 Owner を Manager に変更
  - 新 Owner を Owner に変更
- 研究会参加者ロール変更
  - 権限チェック後にロール更新
- セッション参加者ロール変更
  - 権限チェック後にロール更新
- 研究会参加者の論理削除（脱退・除名）
  - 参加者数/オーナー制約の確認後に論理削除
- セッション参加者の参加取消
  - 参加者数の確認後に論理削除
- 対局結果の作成/更新/削除
  - Match 更新と MatchHistory 追加を同一トランザクションで実行

## 注意点

- 読み取り専用ユースケースは原則トランザクション不要
- トランザクションの開始/終了はアプリケーションサービスが責務を持つ
- リポジトリはトランザクション管理を行わない
